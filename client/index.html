<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Metadata for character set and responsive design -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Stylesheets and favicon -->
    <link rel="stylesheet" href="src/styles/interface-style.css" />
    <link rel="stylesheet" href="src/styles/style.css" />
    <link rel="stylesheet" href="src/styles/subpages-responsive.css" />
    <link rel="icon" href="public/logo_transparent.png" />

    <!-- Title of the page -->
    <title>Cr1pt0 Market, The Ultimate Online Market Platform</title>

    <script src="web3.min.js"></script>
    <script src="truffle-contract.js"></script>
    <script src="jquery-2.1.4.js"></script>
  </head>

  <body>
    <!-- Header Section -->
    <div id="header">
      <!-- Toggleable menu icon -->
      <div id="togglable-menu">
        <input type="checkbox" id="toggle" />
        <label for="toggle" id="toggle-button" onclick="openNav()">&#9776;</label>
      </div>

      <!-- Side Navigation Bar -->
      <div id="side-nav">
        <a href="javascript:void(0)" id="close-button" onclick="closeNav()">&times;</a>
        <a href="index.html">STORE</a>
        <a href="src/pages/about.html">ABOUT</a>
        <a href="src/pages/support.html">SUPPORT</a>
        <a href="src/pages/exchange.html">EXCHANGE</a>
        <!-- <a id="walletAddressDisplay" href="src/pages/profile.php"></a> -->
      </div>

      <!-- Main Navigation Bar -->
      <nav id="nav-bar">
        <a href="index.html" id="logo-link"
          ><img
            src="public/logo_transparent.png"
            alt="Cr1pt0 Market logo"
            width="15%"
            id="header-logo"
        /></a>
        <ul id="menu">
          <li><a href="index.html" class="main-nav-links">STORE</a></li>
          <li><a href="src/pages/about.html" class="main-nav-links">ABOUT</a></li>
          <li><a href="src/pages/support.html" class="main-nav-links">SUPPORT</a></li>
          <li><a href="src/pages/exchange.html" class="main-nav-links">Exchange</a></li>
          <li>
            <a href="" id="connectWalletButton" class="main-nav-links">Connect Wallet</a>
          </li>
          <li>
            <a id="walletAddressDisplay" class="main-nav-links" href="src/pages/profile.php"></a>
          </li>
        </ul>
      </nav>
    </div>

    <div id="main">
      <div class="products">
        <div class="case-nav">
          <a href="#">Popular Items</a>
          <a href="#">Newly Listed</a>
          <a href="src/pages/recentlysold.html">Recently sold</a>
          <input
            type="text"
            id="case-search"
            onkeyup="searchFunction()"
            placeholder="Search.."
            style="font-size: 17px"
          />
        </div>
        <ul id="case-data"></ul>
      </div>
    </div>

    <!-- Footer Section -->
    <div id="footer">
      <div id="logo">
        <a href="index.html" id="logo-link"
          ><img src="public/logo_transparent.png" alt="Cr1pt0 Market logo"
        /></a>
      </div>

      <!-- Copyright and additional information -->
      <div>
        <p>
          &copy; Cr1pt0 Market. All rights reserved. All trademarks are property of their respective
          owners in Vietnam and other countries.
        </p>
        <p>
          Some geospatial data on this website is provided by
          <a href="index.html">Cr1pt0market.org</a>.
        </p>

        <!-- Navigation links for privacy policy, legal, subscriber agreement, and cookies -->
        <nav>
          <ul>
            <li><a href="src/pages/support.html">Privacy Policy</a></li>
            <li><a href="src/pages/support.html">Legal</a></li>
            <li><a href="src/pages/support.html">Cr1pt0 Market Subscriber Agreement</a></li>
            <li><a href="src/pages/about.html">Cookies</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </body>
  <!-- Support JavaScript file -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
  <script src="src/scripts/transition.js"></script>
  <script src="src/scripts/wallet-connection.js"></script>
  <!-- <script src="src/scripts/trade.js"></script> -->
  <script>

    if (window.ethereum) {
        window.web3 = new Web3(window.ethereum);
        window.ethereum.request({ method: 'eth_requestAccounts' })
        .then(() => {
            // Gọi loadWeb3 và các hàm khác sau khi web3 đã được khởi tạo và tài khoản đã được truy cập thành công
            loadWeb3();
        })
        .catch((error) => {
            console.error("User denied account access", error);
        });
    } else {
        console.log('Please install MetaMask!');
    }
    
    // Định nghĩa địa chỉ Ethereum rỗng
    const EMPTY_ADDRESS = '0x0000000000000000000000000000000000000000';
    
    let ticketsEl;
    let friendinstance;
    let casesInfo = [];
    
        async function loadCasesInfo() {
            const response = await fetch('db.json'); 
            const data = await response.json();
            casesInfo = data.cases;
        }
    
        async function loadWeb3() {
          const web3 = window.web3;
        const accounts = await web3.eth.getAccounts();
        console.log("Account: ", accounts[0]);
            ticketsEl = document.getElementById('case-data'); 
    
            $.getJSON("http://localhost/Steam_Market/build/contracts/CaseSale.json", async function(data) {
                const FriendArtifact = data;
                friendinstance = new web3.eth.Contract(FriendArtifact.abi, FriendArtifact.networks['5777'].address);
                console.log(friendinstance);
                await refreshTickets(); // Cập nhật để sử dụng async
            });
        }
    
        async function refreshTickets() {
      await loadCasesInfo();
      ticketsEl.innerHTML = ''; // Xóa danh sách hiện tại để làm mới
      
      const accounts = await web3.eth.getAccounts();
      
      for (let i = 0; i < casesInfo.length; i++) {
        let shouldDisplay = true; // Mặc định là hiển thị case
        
        // Nếu có account được kết nối, kiểm tra xem case đã được mua chưa
        if (accounts.length > 0) {
          const ticket = await friendinstance.methods.cases(i).call();
          console.log(ticket);
          shouldDisplay = ticket.owner === EMPTY_ADDRESS; // Chỉ hiển thị nếu chưa được mua
        }
        
        if (shouldDisplay) {
          const item = casesInfo[i];
          // Tạo một div mới và thêm class 'case-card'
          const ticketEl = document.createElement('div');
          ticketEl.classList.add('case-card');
          ticketEl.innerHTML = `
            <img src="${item.image}" alt="${item.name}" style="width:100%">
            <div class="case-info">
              <h3>${item.name}</h3>
              <p>Quantity: ${item.quantity}</p>
              <p>Buy Price: ${item.buy_price} CC</p>
              <p>Sale Price: ${item.sale_price} CC</p>
              <p>Container Series: ${item.container_series}</p>
              <button onclick="buyCases(${i}, '${item.price}')">Buy Case</button>
            </div>
          `;
          // Thêm card mới vào phần tử chứa
          ticketsEl.appendChild(ticketEl);
        }
      }
    }
    
    
        async function buyCases(caseId, buyPriceCC) {
          async function buyCase(caseId) {
  if (!window.web3) {
    console.log('Web3 not initialized. Ensure MetaMask is installed and connected.');
    return;
  }
  
  const web3 = window.web3;
  const accounts = await web3.eth.getAccounts();
  if (accounts.length === 0) {
    console.error('No accounts accessible. Make sure you are logged into MetaMask.');
    return;
  }
  
  const account = accounts[0];
  try {
    const caseToBuy = casesInfo[caseId]; // Assuming casesInfo holds your case data, including price in CC
    if (!caseToBuy) {
      console.error('Case not found.');
      return;
    }

    // Let's assume 1 CC = 0.01 Ether for conversion. Adjust as necessary.
    const etherValue = web3.utils.toWei((caseToBuy.price * 0.01).toString(), 'ether');

    await friendinstance.methods.buyCase(caseId)
      .send({ from: account, value: etherValue })
      .then(() => {
        console.log(`Case ${caseId} bought successfully.`);
        // Optionally, refresh or update your UI here
        displayTransactions(); // Assuming you want to update the transaction list
      });
  } catch (error) {
    console.error('Error buying case:', error);
  }
}

    
    
    </script>
</html>
